# 数据库逻辑设计

## 表结构设计

### 使用DDD概念进行初步设计

使用DDD领域驱动模型概念去对表结构进行初步划分。

- DDD是一种软件架构设计方法，并不定义软件开发过程（DevOps）
- DDD利用面向对象特性，以业务驱动为核心，而不是传统的数据库（表）驱动开发
- 领域是对功能需求的划分；大的领域下面还有很多小的子领域
  - 先去了解功能需求，然后对产品做业务层面的划分，例如，需求：电商平台，大的领域：电商领域，小的领域：商品，订单，账户，物流等等。



我们可以对产品业务层进行拆分，例如电商领域下，拆分出的小领域，可从中发现领域之间的关联依赖关系，从上述的电商领域，可以发现这几个领域的核心是订单，发现依赖关系后，就可以对这些子领域进行进一步的拆分，做好领域之间的关联字段或者表，这样就可以初步完成表结构设计，初步完成后，就可以开始优化，确保系统性能、数据完整性和可维护性。

### 表结构优化

#### **1. 数据库规范化**

确保数据库满足适当的范式要求，以减少数据冗余和异常：

- **第一范式 (1NF)：** 确保表中每一列都是原子值，没有重复数据。
- **第二范式 (2NF)：** 确保所有非主键列都完全依赖于主键。
- **第三范式 (3NF)：** 消除传递依赖，确保非主键列直接依赖于主键，而不是通过其他列间接依赖。

**优化时需注意：**
规范化太彻底可能导致查询性能下降。在实际项目中，适当的**反规范化**（如冗余字段或表合并）可能更符合业务需求。

------

#### **2. 确定主键、外键和索引**

- **主键 (Primary Key)：** 确保每张表有唯一标识记录的字段，通常选用业务含义明确的字段（如用户 ID）。
- **外键 (Foreign Key)：** 定义表间关联关系，但要注意在高并发场景下，过多外键可能影响性能，可以用应用逻辑替代外键约束。
- 索引 (Index)：
  - 建立常用查询字段的索引（如用户 ID、创建时间等）。
  - 使用组合索引优化多条件查询（如 `WHERE name = ? AND age = ?`）。
  - 避免过多索引，影响写入性能。

**工具：** 可以使用数据库自带的 `EXPLAIN` 命令分析查询性能。

------

#### **3. 检查字段设计**

- 数据类型优化：
  - 使用合适的字段类型（如 INT 代替 BIGINT，CHAR 代替 VARCHAR，避免使用 TEXT）。
  - 精简字段长度（如手机号字段长度可限定为 11 位）。
- **默认值设置：** 为字段提供合理的默认值，减少 NULL 值存储，优化查询。
- **字段命名规范：** 避免字段命名歧义，确保字段名简洁、易懂且业务明确。

---

#### **4. 关注表关系和关联方式**

- **消除多余的表：** 检查是否存在冗余表或关系复杂但没有实际业务需求的表。
- **优化多对多关系：** 使用中间表解决多对多关系，同时优化中间表字段设计。

---

#### **5. 优化查询性能**

- 慢查询分析：
  - 使用数据库的慢查询日志（如 MySQL 的 `slow_query_log`）定位低效查询。
- **避免全表扫描：** 确保查询条件（`WHERE` 子句）字段有索引支持。

---

#### **6. 考虑分表分库**

对于大规模数据，提前规划分库分表策略：

- **垂直分表：** 按模块划分表结构（如将用户信息与用户登录信息分为两张表）。
- **水平分表：** 按数据量分割（如按用户 ID 分表）。
- **分库：** 数据按业务逻辑分布在不同数据库中（如按地区或时间分库）。

---

#### **7. 数据完整性约束**

- **唯一约束 (UNIQUE)：** 确保某些字段的值在表中唯一（如邮箱）。
- **非空约束 (NOT NULL)：** 避免不必要的 NULL 数据，减少存储空间和复杂性。
- **检查约束 (CHECK)：** 限定字段值的范围或条件（如性别字段限定为 `M` 或 `F`）。

---

#### **8. 模拟业务场景测试**

通过模拟业务场景，对表结构进行负载测试：

- 测试高并发写入和查询场景的性能。
- 检查表设计是否能快速适应业务数据增长（如是否需要分表或索引调整）。

---

#### **9. 使用工具进行优化**

- **ER 图工具：** 使用工具（如 PowerDesigner、MySQL Workbench）可视化数据库表结构，检查关系设计是否清晰。
- **性能监控工具：** 结合数据库监控工具（如 PMM、Navicat）实时分析表设计的性能表现。

---

#### **10. 代码层优化建议**

在数据库表结构优化后，还需在代码层面进行优化：

- **分页查询：** 避免全量数据加载，使用分页加载（如 `LIMIT OFFSET`）。
- **缓存策略：** 对高频查询结果使用缓存（如 Redis）。
- **批量操作：** 写入和更新操作尽量批量执行，减少对数据库的压力。

------

通过以上方法反复迭代，你的表结构将更高效、可维护且符合实际业务需求。

### 微服务，或分布式系统下的表结构

微服务中，各服务是独立的，虽然服务的初期各服务之间，共享一个数据表，但为了后期的可扩展性和服务解耦性，通常不建议在微服务架构中的数据表出现外键约束。因为有以下几点：

- 共享数据库也不使用外键约束：
  - 为数据拆分作准备。
  - 允许服务之间的数据不一致：微服务架构中一致性一般通过最终一致性来保证。
  - 降低系统耦合度：在共享模式下，如果使用外键约束，一旦某个服务重构或修改数据表，其他服务也会受到影响。
- 替代方案：
  - 在逻辑层实现关联
    - 假设一个订单服务，需要校验用户是否存在，可以通过用户服务的API或者缓存来查询。
  - 通过消息队列保持数据一致性
    - 事件驱动模型：用户服务和订单服务通过消息队列（如 Kafka）实现解耦，当用户被删除时，用户服务发送 `UserDeleted` 事件，订单服务监听该事件并处理相关订单。
  - 直接使用字段关联
    - 直接在order表中增加user_id，但不用外键约束。
    - 复杂业务使用中间表。